<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>é€šçŸ¥ä¸­å¿ƒ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 2rem; font-family: "Noto Sans TC", sans-serif; background: #f8fafc; }
    h1 { color: #0d6efd; margin-bottom: 2rem; }
    .unread { background-color: #e9f3ff; font-weight: bold; }
    .read { color: #555; }
    .btn-sm { margin-right: 0.25rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>é€šçŸ¥ä¸­å¿ƒ</h1>

    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>æ¨™é¡Œ</th>
          <th>å…§å®¹</th>
          <th>æ™‚é–“</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="notifTable"></tbody>
    </table>
  </div>

  <script>
  async function loadNotifications() {
    const res = await fetch('/api/my_notifications');
    const data = await res.json();
    const tbody = document.getElementById('notifTable');
    tbody.innerHTML = '';

    if (!data.success) {
      alert('è¼‰å…¥å¤±æ•—');
      return;
    }

    data.notifications.forEach(n => {
      const row = document.createElement('tr');
      row.className = n.is_read ? 'read' : 'unread';
      row.innerHTML = `
        <td>${n.is_read ? 'âœ…' : 'ğŸ†•'} ${n.title}</td>
        <td>${n.message.replace(/\n/g, '<br>')}</td>
        <td>${new Date(n.created_at).toLocaleString('zh-TW', { hour12: false })}</td>
        <td>
          ${n.link_url ? `<a href="${n.link_url}" class="btn btn-sm btn-primary">å‰å¾€</a>` : ''}
          ${!n.is_read ? `<button class="btn btn-sm btn-success" onclick="markRead(${n.id})">å·²è®€</button>` : ''}
          <button class="btn btn-sm btn-danger" onclick="deleteNotif(${n.id})">åˆªé™¤</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  async function markRead(id) {
    const res = await fetch(`/api/mark_read/${id}`, { method: 'POST' });
    const data = await res.json();
    if (!data.success) return alert(data.message);
    const row = document.querySelector(`button[onclick="markRead(${id})"]`).closest('tr');
    row.classList.remove('unread');
    row.classList.add('read');
    row.querySelector('td:first-child').innerText = 'âœ… ' + row.querySelector('td:first-child').innerText.slice(2);
    row.querySelector('button.btn-success').remove();
  }

  async function deleteNotif(id) {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤é€šçŸ¥ï¼Ÿ")) return;
    const res = await fetch(`/api/notification/delete/${id}`, { method: 'DELETE' });
    const data = await res.json();
    alert(data.message);
    loadNotifications();
  }

  loadNotifications();
  </script>
</body>
</html>
