<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>個人資料管理</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f4f8;
      padding: 20px;
    }

    .container {
      max-width: 400px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 15px;
    }

    input,
    select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    input[readonly] {
      background: #eee;
    }

    .avatar-preview {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ccc;
      margin: 0 auto 10px;
      display: block;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .buttons {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>個人資料</h2>

    <img id="avatarPreview" class="avatar-preview" src="https://via.placeholder.com/100?text=頭像" alt="頭像預覽" />

    <div id="page1" class="page active">
      <label for="avatarUpload">上傳頭像</label>
      <input type="file" id="avatarUpload" accept="image/*" />

      <label for="identity">身分</label>
      <input id="identity" type="text" readonly />

      <!-- 學生專用欄位 -->
      <div id="studentFields" class="role-specific-fields" style="display: none;">
        <label for="combinedClass">班級</label>
        <input id="combinedClass" type="text" readonly />
        
        <label for="studentId">學號</label>
        <input id="studentId" type="text" readonly />
      </div>

      <!-- 教師專用欄位 -->
      <div id="teacherFields" class="role-specific-fields" style="display: none;">
        <label for="teacherId">教師編號</label>
        <input id="teacherId" type="text" readonly />
      </div>

      <!-- 主任專用欄位 -->
      <div id="directorFields" class="role-specific-fields" style="display: none;">
        <label for="directorId">主任編號</label>
        <input id="directorId" type="text" readonly />
      </div>

      <!-- 科助專用欄位 -->
      <div id="taFields" class="role-specific-fields" style="display: none;">
        <label for="taId">科助編號</label>
        <input id="taId" type="text" readonly />
      </div>

      <!-- 管理員專用欄位 -->
      <div id="adminFields" class="role-specific-fields" style="display: none;">
        <label for="adminId">管理員編號</label>
        <input id="adminId" type="text" readonly />
      </div>

      <label for="name">姓名</label>
      <input id="name" type="text" />

    </div>

    <div id="page2" class="page">
      <label for="email">電子郵件</label>
      <input id="email" type="email" readonly />

      <label for="oldPassword">舊密碼</label>
      <input type="password" id="oldPassword" />

      <label for="newPassword">新密碼</label>
      <input type="password" id="newPassword" />

      <label for="confirmPassword">確認新密碼</label>
      <input type="password" id="confirmPassword" />
    </div>

    <div class="buttons">
      <button id="prevBtn" disabled>上一頁</button>
      <button id="nextBtn">下一頁</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const pages = document.querySelectorAll('.page');
      let currentPage = 0;

      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      // 用來儲存 class_id 後續更新用
      window.classId = null;

      // *** 修正: 將 roleMap 和 roleMapReverse 放在 DOMContentLoaded 的頂層作用域 ***
      const roleMap = {
        "student": "學生",
        "teacher": "教師",
        "director": "主任",
        "ta": "科助",
        "admin": "管理員"
      };
      const roleMapReverse = {
        "學生": "student",
        "教師": "teacher",
        "主任": "director",
        "科助": "ta",
        "管理員": "admin"
      };
      // *** 修正結束 ***

      function showPage(index) {
        pages.forEach((page, i) => page.classList.toggle('active', i === index));
        prevBtn.disabled = index === 0;
        nextBtn.textContent = index === pages.length - 1 ? '完成' : '下一頁';
      }

      // 根據使用者身分顯示相應的欄位
      function showRoleSpecificFields(role) {
        // 隱藏所有角色專用欄位
        const allRoleFields = document.querySelectorAll('.role-specific-fields');
        allRoleFields.forEach(field => {
          field.style.display = 'none';
        });

        // 根據角色顯示相應欄位
        switch(role) {
          case 'student':
            document.getElementById('studentFields').style.display = 'block';
            break;
          case 'teacher':
            document.getElementById('teacherFields').style.display = 'block';
            break;
          case 'director':
            document.getElementById('directorFields').style.display = 'block';
            break;
          case 'ta':
            document.getElementById('taFields').style.display = 'block';
            break;
          case 'admin':
            document.getElementById('adminFields').style.display = 'block';
            break;
        }
      }

      // 載入用戶資料
      fetch('/api/profile')
        .then(res => {
          if (!res.ok) throw new Error('無法取得用戶資料');
          return res.json();
        })
        .then(data => {
          if (!data.success) throw new Error(data.message || '取得資料失敗');
          const user = data.user;

          // 頭像 - 加上時間戳避免快取造成顯示舊圖
          const initialAvatarUrl = user.avatar_url ? (user.avatar_url + '?t=' + Date.now()) : 'https://via.placeholder.com/100?text=頭像';
          document.getElementById('avatarPreview').src = initialAvatarUrl;

          // 身分轉換
          document.getElementById('identity').value = roleMap[user.role] || '';

          // 根據使用者身分顯示相應的欄位
          showRoleSpecificFields(user.role);

          // 根據身分填入相應的資料
          if (user.role === 'student') {
            // 班級顯示 & 存 class_id
            if (user.classes && user.classes.length > 0) {
              document.getElementById('combinedClass').value = user.classes
                .map(c => (c.department.replace("管科", "") + c.name))
                .join("、");
            } else {
              document.getElementById('combinedClass').value = user.class_display_name || '';
            }
            window.classId = user.class_id || null;
            document.getElementById('studentId').value = user.username || '';
          } else if (user.role === 'teacher') {
            document.getElementById('teacherId').value = user.username || '';
          } else if (user.role === 'director') {
            document.getElementById('directorId').value = user.username || '';
          } else if (user.role === 'ta') {
            document.getElementById('taId').value = user.username || '';
          } else if (user.role === 'admin') {
            document.getElementById('adminId').value = user.username || '';
          }

          document.getElementById('name').value = user.name || '';
          document.getElementById('email').value = user.email || '';
        })
        .catch(err => alert(err.message));

      prevBtn.addEventListener('click', () => {
        if (currentPage > 0) {
          currentPage--;
          showPage(currentPage);
        }
      });

      nextBtn.addEventListener('click', () => {
        if (currentPage < pages.length - 1) {
          currentPage++;
          showPage(currentPage);
        } else {
          // 完成按鈕，送出資料

          const avatarFile = document.getElementById('avatarUpload').files[0];

          // 上傳頭像（如果有）
          function uploadAvatar() {
            if (!avatarFile) return Promise.resolve(null);

            const formData = new FormData();
            formData.append('avatar', avatarFile);

            return fetch('/api/upload_avatar', {
              method: 'POST',
              body: formData,
            })
              .then(res => res.json())
              .then(data => {
                if (!data.success) throw new Error(data.message || '頭像上傳失敗');
                return data.avatar_url; // 回傳頭像URL
              });
          }

          uploadAvatar()
            .then(avatarUrl => {
              // 如果有新的頭像URL，更新預覽（加上時間戳避免被舊圖覆蓋）
              if (avatarUrl) {
                document.getElementById('avatarPreview').src = avatarUrl + '?t=' + Date.now();
              }
              
              // 更新個人資料
              const roleDisplayValue = document.getElementById('identity').value;
              const roleValue = roleMapReverse[roleDisplayValue] || 'student'; // 取得英文 role
              
              const classIdToSend = roleValue === 'student' ? window.classId : null;

              if (roleValue === 'student' && !classIdToSend) {
                alert('學生身分必須選擇班級！');
                throw new Error('學生身分缺少班級');
              }

              // 根據身分取得相應的 username
              let username = '';
              if (roleValue === 'student') {
                username = document.getElementById('studentId').value;
              } else if (roleValue === 'teacher') {
                username = document.getElementById('teacherId').value;
              } else if (roleValue === 'director') {
                username = document.getElementById('directorId').value;
              } else if (roleValue === 'ta') {
                username = document.getElementById('taId').value;
              } else if (roleValue === 'admin') {
                username = document.getElementById('adminId').value;
              }

              const payload = {
                username: username,
                // 後端 /api/saveProfile 預期收到中文 role 顯示值 (role_display)
                role: roleDisplayValue, 
                name: document.getElementById('name').value,
                class_id: classIdToSend,
              };

              return fetch('/api/saveProfile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
              })
                .then(res => res.json())
                .then(data => {
                  if (!data.success) throw new Error(data.message || '更新個人資料失敗');
                  return { avatarUrl, roleValue }; // 傳遞 roleValue
                });
            })
            .then(({ roleValue }) => {
              // 變更密碼（如果有填）
              const oldPwd = document.getElementById('oldPassword').value.trim();
              const newPwd = document.getElementById('newPassword').value.trim();
              const confirmPwd = document.getElementById('confirmPassword').value.trim();

              if (oldPwd || newPwd || confirmPwd) {
                if (newPwd !== confirmPwd) {
                  alert('新密碼與確認新密碼不符！');
                  throw new Error('密碼確認失敗');
                }
                return fetch('/api/change_password', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ old_password: oldPwd, new_password: newPwd }),
                })
                  .then(res => res.json())
                  .then(data => {
                    if (!data.success) throw new Error(data.message || '變更密碼失敗');
                    alert('資料及密碼更新成功！');
                    // 根據 roleValue (英文代碼) 跳轉
                    if (roleValue === 'student') {
                      window.location.href = '/student_home';
                    } else if (roleValue === 'ta') {
                      window.location.href = '/ta_home';
                    } else if (roleValue === 'teacher') {
                      window.location.href = '/teacher_home';
                    } else if (roleValue === 'director') {
                      window.location.href = '/director_home';
                    } else {
                      window.location.href = '/student_home'; // 預設跳轉
                    }
                  });
              } else {
                alert('資料更新成功！');
                // 根據 roleValue (英文代碼) 跳轉
                if (roleValue === 'student') {
                  window.location.href = '/student_home';
                } else if (roleValue === 'ta') {
                  window.location.href = '/ta_home';
                } else if (roleValue === 'teacher') {
                  window.location.href = '/teacher_home';
                } else if (roleValue === 'director') {
                  window.location.href = '/director_home';
                } else {
                  window.location.href = '/student_home'; // 預設跳轉
                }
              }
            })
            .catch(err => alert(err.message));
        }
      });

      // 頭像預覽功能
      document.getElementById('avatarUpload').addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = event => {
            document.getElementById('avatarPreview').src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      showPage(currentPage);
    });
  </script>
</body>

</html>